<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="300"> <title>Monitoramento - V3LAN</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f5f7fa; color: #333; }
        h1 { text-align: center; color: #2c3e50; }
        #last-updated { text-align: center; color: #7f8c8d; font-style: italic; margin-top: -15px; }
        table { width: 95%; margin: 20px auto; border-collapse: collapse; box-shadow: 0 2px 10px rgba(0,0,0,0.1); background-color: #fff; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #34495e; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr.total-row { background-color: #34495e; color: white; font-weight: bold; font-size: 1.1em; }
        tr:hover { background-color: #f1f1f1; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 15px; color: white; text-align: center; }
        .status-online { background-color: #27ae60; } /* Verde */
        .status-stale { background-color: #f39c12; } /* Amarelo */
        .status-offline { background-color: #e74c3c; } /* Vermelho */
        .status-loading { background-color: #7f8c8d; } /* Cinza */
        a { color: #3498db; text-decoration: none; font-weight: bold; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <h1>Monitoramento - V3LAN</h1>
    <p id="last-updated">Carregando...</p>

    <table>
        <thead>
            <tr>
                <th>Status</th>
                <th>Garagem</th>
                <th>Online</th>
                <th>Offline</th>
                <th>TGs (Ontem)</th>
                <th>Última Atualização (Bot)</th>
                <th>Painel</th>
            </tr>
        </thead>
        <tbody id="dashboard-body">
            <tr id="loading-row">
                <td colspan="7" style="text-align: center; font-size: 1.2em; padding: 20px;">Carregando dados dos servidores...</td>
            </tr>
        </tbody>
    </table>

    <script src="garagens.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tbody = document.getElementById('dashboard-body');
            const lastUpdatedEl = document.getElementById('last-updated');
            const loadingRow = document.getElementById('loading-row');

            lastUpdatedEl.textContent = `Carregando... (Página atualizou às ${new Date().toLocaleTimeString('pt-BR')})`;

            const fetchPromises = GARAGENS.map(garagem => {
                const url = `${garagem}_status.json?t=${new Date().getTime()}`;
                return fetch(url)
                    .then(response => {
                        if (!response.ok) { throw new Error('Bot offline ou JSON não encontrado'); }
                        return response.json();
                    })
                    .then(data => ({ status: 'fulfilled', data }))
                    .catch(error => ({ status: 'rejected', garagem, error: error.message }));
            });

            Promise.all(fetchPromises)
                .then(results => {
                    loadingRow.style.display = 'none';
                    
                    let totalOnline = 0;
                    let totalOffline = 0;
                    let totaltgs_count = 0; 

                    results.forEach(result => {
                        let statusClass = 'status-offline';
                        let statusText = 'Offline';
                        let rowHtml = '';
                        let panelLink = '---';
                        let tgLink = '---';

                        if (result.status === 'fulfilled') {
                            const data = result.data;
                            const lastUpdate = new Date(data.last_update);
                            const now = new Date();
                            
                            const cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 7, 30, 0);

                            if (data.offline === "ERRO") {
                                statusClass = 'status-offline';
                                statusText = 'Falha no Bot';
                            } else if (lastUpdate > cutoff) {
                                statusClass = 'status-online';
                                statusText = 'Online';
                            } else if (now < cutoff) {
                                statusClass = 'status-online';
                                statusText = 'Online (Aguardando)';
                            } else {
                                statusClass = 'status-stale';
                                statusText = 'Desatualizado';
                            }

                            totalOnline += (typeof data.online === 'number' ? data.online : 0);
                            totalOffline += (typeof data.offline === 'number' ? data.offline : 0);
                            totaltgs_count += (typeof data.tgs_count === 'number' ? data.tgs_count : 0);

                            // (MELHORIA: Constrói o link do Painel Individual)
                            if(data.panel_url && data.panel_url !== "N/A") {
                                panelLink = `<a href="${data.panel_url}" target="_blank">Abrir</a>`;
                            } else {
                                panelLink = `<a href="COMUNICAÇÕES_${data.garagem}.html" target="_blank">Abrir (Local)</a>`;
                            }
                            
                            // (MELHORIA: Constrói o link de Download do CSV dos TGs)
                            // (Nota: Isto assume que o CSV está no mesmo repo mestre 'tcm-forquilha')
                            if(data.tgs_filename && data.tgs_filename !== "N/A") {
                                tgLink = `<a href="${data.tgs_filename}" download>${data.tgs_count} (Baixar)</a>`;
                            } else {
                                tgLink = data.tgs_count;
                            }

                            rowHtml = `
                                <tr>
                                    <td><span class="status ${statusClass}">${statusText}</span></td>
                                    <td>${data.garagem}</td>
                                    <td>${data.online}</td>
                                    <td>${data.offline}</td>
                                    <td>${tgLink}</td>
                                    <td>${lastUpdate.toLocaleString('pt-BR')}</td>
                                    <td>${panelLink}</td>
                                </tr>
                            `;
                        } else {
                            // Bot falhou (404, etc)
                            rowHtml = `
                                <tr>
                                    <td><span class="status ${statusClass}">${statusText}</span></td>
                                    <td>${result.garagem}</td>
                                    <td>---</td>
                                    <td>---</td>
                                    <td>---</td>
                                    <td>---</td>
                                    <td><a href="COMUNICAÇÕES_${result.garagem}.html" target="_blank">Abrir (Cache)</a></td>
                                </tr>
                            `;
                        }
                        tbody.innerHTML += rowHtml;
                    });

                    // Adiciona linha de Total
                    tbody.innerHTML += `
                        <tr class="total-row">
                            <td colspan="2">TOTAL GERAL</td>
                            <td>${totalOnline}</td>
                            <td>${totalOffline}</td>
                            <td>${totaltgs_count}</td>
                            <td colspan="2"></td> 
                        </tr>
                    `;
                });
        });
    </script>
</body>
</html>
