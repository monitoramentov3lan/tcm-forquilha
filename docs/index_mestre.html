<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Mestre de Frota</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { width: 95%; max-width: 1800px; margin: 0 auto; }
        h1 { text-align: center; color: #2c3e50; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,.08); }
        .controls label { font-weight: 600; margin-right: 10px; }
        .controls select, .controls input { font-size: 1em; padding: 8px; border-radius: 6px; border: 1px solid #ddd; }
        #loading { text-align: center; font-size: 1.5em; color: #555; padding: 40px; }
        table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 10px rgba(0,0,0,0.1); background-color: #fff; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #34495e; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #e9ecef; }
        .status { font-weight: 700; padding: 4px 8px; border-radius: 12px; color: white; font-size: .85em; text-align:center; min-width: 110px; display: inline-block;}
        .status-online { background-color: #27ae60; }
        .status-offline { background-color: #e74c3c; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Painel de Comunicação de Frota Completa</h1>

        <div class="controls">
            <div>
                <label for="empresa-filter">Filtrar por Empresa:</label>
                <select id="empresa-filter" onchange="filterTable()">
                    <option value="TODAS">TODAS AS EMPRESAS</option>
                </select>
            </div>
            <div>
                <label for="status-filter">Filtrar por Status:</label>
                <select id="status-filter" onchange="filterTable()">
                    <option value="TODOS">Todos</option>
                    <option value="ONLINE">Apenas Online</option>
                    <option value="OFFLINE">Apenas Offline</option>
                </select>
            </div>
            <div>
                <label for="search-box">Buscar Prefixo:</label>
                <input type="text" id="search-box" onkeyup="filterTable()" placeholder="Digite o prefixo...">
            </div>
        </div>

        <div id="loading">Carregando dados de 26 garagens...</div>

        <table>
            <thead>
                <tr>
                    <th>Empresa</th>
                    <th>Prefixo</th>
                    <th>Status</th>
                    <th>Tempo Offline</th>
                    <th>Última Comunicação</th>
                </tr>
            </thead>
            <tbody id="vehicle-table-body">
                <!-- Linhas serão inseridas pelo JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Carrega a sua lista de garagens (Ex: GARAGENS = ["ESTRELA", "RATRANS", ...]) -->
    <script src="garagens.js"></script>
    <!-- Carrega a sua função de mapeamento (Python -> JS) -->
    <script src="identificar_empresa.js"></script>

    <script>
        let allVehicles = []; // Onde todos os dados da frota irão viver

        /** Função principal para carregar e construir o painel */
        async function initializeDashboard() {
            const loadingEl = document.getElementById('loading');
            const tbody = document.getElementById('vehicle-table-body');
            const empresaFilter = document.getElementById('empresa-filter');

            try {
                // 1. Criar uma lista de promessas para buscar todos os JSON de veículos
                const fetchPromises = GARAGENS.map(garagem => {
                    const url = `${garagem}_vehicles.json?t=${new Date().getTime()}`;
                    return fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                console.warn(`Não foi possível carregar ${url}. Bot pode estar offline.`);
                                return []; // Retorna lista vazia em vez de falhar
                            }
                            return response.json();
                        })
                        .catch(error => {
                            console.error(`Erro ao buscar ${garagem}: ${error}`);
                            return []; // Retorna lista vazia em caso de erro de rede
                        });
                });

                // 2. Esperar que todos os JSONs sejam descarregados
                const vehicleArrays = await Promise.all(fetchPromises);
                
                // 3. Juntar todos os arrays num só e processar
                allVehicles = vehicleArrays.flat(); // Junta [[...], [...]] em [...]
                let empresas = new Set(); // Para popular o filtro

                allVehicles.forEach(vehicle => {
                    // 4. Usar a sua função 'identificar_empresa.js'
                    vehicle.Empresa = identificar_empresa(vehicle.Veículo);
                    empresas.add(vehicle.Empresa);
                });
                
                // 5. Ordenar a lista de empresas e popular o dropdown de filtro
                [...empresas].sort().forEach(empresa => {
                    const option = document.createElement('option');
                    option.value = empresa;
                    option.textContent = empresa;
                    empresaFilter.appendChild(option);
                });

                // 6. Renderizar a tabela pela primeira vez
                renderTable(allVehicles);
                loadingEl.style.display = 'none';

            } catch (error) {
                loadingEl.textContent = "Erro fatal ao carregar os dados. Verifique a consola.";
                console.error("Erro no initializeDashboard:", error);
            }
        }

        /** Renderiza as linhas da tabela */
        function renderTable(vehicles) {
            const tbody = document.getElementById('vehicle-table-body');
            let html = '';

            for (const vehicle of vehicles) {
                const statusClass = vehicle.Status.toLowerCase() === 'online' ? 'status-online' : 'status-offline';
                
                html += `
                    <tr class="vehicle-row" 
                        data-empresa="${vehicle.Empresa}" 
                        data-status="${vehicle.Status.toUpperCase()}"
                        data-veiculo="${vehicle.Veículo}">
                        <td>${vehicle.Empresa}</td>
                        <td><strong>${vehicle.Veículo}</strong></td>
                        <td><span class="status ${statusClass}">${vehicle.Status.toUpperCase()}</span></td>
                        <td>${vehicle.Status.toLowerCase() === 'offline' ? vehicle.TempoOffline : '---'}</td>
                        <td>${vehicle.Última_Comunicação}</td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        /** Filtra a tabela com base nos controlos */
        function filterTable() {
            const empresaFilter = document.getElementById('empresa-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchFilter = document.getElementById('search-box').value.toLowerCase();
            
            const rows = document.getElementById('vehicle-table-body').getElementsByTagName('tr');
            
            for (const row of rows) {
                const empresa = row.dataset.empresa;
                const status = row.dataset.status;
                const veiculo = row.dataset.veiculo;

                const showEmpresa = (empresaFilter === 'TODAS' || empresa === empresaFilter);
                const showStatus = (statusFilter === 'TODOS' || status === statusFilter);
                const showSearch = (veiculo.toLowerCase().includes(searchFilter));

                if (showEmpresa && showStatus && showSearch) {
                    row.style.display = ''; // Mostra a linha
                } else {
                    row.style.display = 'none'; // Esconde a linha
                }
            }
        }

        // Inicia tudo
        initializeDashboard();
    </script>
</body>
</html>
